
# Story 10.6: Robust State Handling for HomeScreen (Initial Load, Empty, Error)

**Status:** Draft

## Goal & Context

**User Story:** As a user, I want the HomeScreen to clearly communicate its status, whether it's loading initial photos, encounters an error, or if (hypothetically) no trending photos are available.

**Context:** This story ensures the `HomeScreen` gracefully handles all its primary states: initial data loading, displaying content (the photo grid), an empty state (if no photos are returned), and error states (network/API issues during initial load). It builds on Story 10.1 (basic loading) and uses `ErrorView` from Epic 5. This aligns with PRD v1.2 [45], [90], [190], [210], [235], [460]-[461], [481], [506] and research [State Management section].

## Detailed Requirements

* `HomeScreenViewModel.uiState` (or individual state flows) will comprehensively cover:
    * `isLoadingInitial: Boolean`
    * `photos: List<Photo>`
    * `isEmpty: Boolean` (derived: true if `!isLoadingInitial` and `photos.isEmpty()` and no error and search *was* attempted)
    * `error: UserFacingError?` (for initial load errors)
* **Initial Load:** When `HomeScreenViewModel.isLoadingInitial` is true (and list is empty, no error):
    * `HomeScreen` displays a centered `CircularProgressIndicator` or a full-screen shimmer placeholder over a skeleton grid structure (more advanced than just a spinner, aligns with Story 10.5's shimmer intent).
* **Empty State:** If `ImageRepository` returns an empty list for the initial `/v1/curated` fetch (and not in an error state and loading is finished):
    * `HomeScreenViewModel` sets/derives an `isEmpty` state to true.
    * `HomeScreen` displays a user-friendly message (e.g., "No trending photos to show right now. Try refreshing!").
* **Error State:** If the initial fetch from `ImageRepository` (for `/v1/curated`) results in an error:
    * `HomeScreenViewModel.errorState` (or `uiState.errorMessage`) is populated with a `UserFacingError`.
    * `HomeScreen` displays a centered `ErrorView` Composable (reused from Story 5.1) with the message and a "Retry" button that calls a `retryInitialLoad()` (or `WorkspaceInitialPhotos()`) function in `HomeScreenViewModel`.
* Use `AnimatedVisibility` or `Crossfade` (from Epic 9, Story 9.3) to smoothly transition between these primary states on `HomeScreen`.

## Acceptance Criteria (ACs)

* AC1: A full-screen loading indicator (e.g., centered `CircularProgressIndicator` or skeleton shimmer) is shown on `HomeScreen` when `HomeScreenViewModel.isLoadingInitial` is true and photos are not yet loaded and no error has occurred.
* AC2: If the initial curated photo list from the API is empty (and no error, loading finished), `HomeScreen` displays a user-friendly "empty state" message (e.g., "No trending photos available."). The grid is hidden.
* AC3: If the initial data fetch for `HomeScreen` fails, a full-screen `ErrorView` with a descriptive message and a "Retry" button is displayed. The grid/empty message is hidden.
* AC4: Clicking the "Retry" button on the `ErrorView` triggers `HomeScreenViewModel` to re-attempt fetching initial curated photos.
* AC5: Transitions between loading, content (photo grid), empty, and error states on `HomeScreen` are smooth and clear (e.g., using `Crossfade` or `AnimatedVisibility`). Only one state is predominantly visible.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Stories 10.1 and parts of 10.5 (shimmer concept) are relevant. ErrorView from Epic 5 is used.

* **Relevant Files:**
    * Files to Modify:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreenViewModel.kt`
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreen.kt`
    * _(Hint: `research-homescreen-trending-photos.md` [State Management section]. `coding-standards.md`.)_

* **Key Technologies:**
    * `HomeScreenViewModel` state management (`StateFlow`, `UserFacingError`).
    * Jetpack Compose: Conditional rendering, `CircularProgressIndicator`, `ErrorView` (reusable), `Text`, `AnimatedVisibility` or `Crossfade`.
    * _(Hint: `tech-stack.md`.)_

* **API Interactions / SDK Usage:**
    * Handles states resulting from `imageRepository.getCuratedPhotos()` calls.
    * _(Hint: `api-reference.md`)_

* **Data Structures:**
    * `HomeScreenViewModel` to clearly expose `isLoadingInitial`, `photosList`, `errorState`, and a derived `isEmpty` state (or a combined `UiState` sealed interface).
    * _(Hint: See `data-models.md v1.1`.)_

* **Environment Variables:**
    * Not applicable.
    * _(Hint: See `environment-vars.md`)_

* **Coding Standards Notes:**
    * State representation in ViewModel should be clear and unambiguous. A sealed interface for `UiState` (`Loading`, `Success`, `Error`, `Empty`) is a robust pattern.
    * UI should reactively display one of these primary states.
    * Ensure retry logic correctly re-initiates the initial load.
    * Animations between states should be consistent with Story 9.3.
    * Adhere to `docs/coding-standards.md`.
    * _(Hint: See `docs/coding-standards.md`.)_

## Tasks / Subtasks

* [ ] **Refine `HomeScreenViewModel.kt` State Management:**
    * [ ] If not already using a sealed `UiState` for `HomeScreen`, consider refactoring:
      ```kotlin
      // sealed interface HomeScreenUiState {
      //     data object Loading : HomeScreenUiState
      //     data class Success(val photos: List<Photo>) : HomeScreenUiState
      //     data class Error(val error: UserFacingError) : HomeScreenUiState
      //     data object Empty : HomeScreenUiState
      // }
      // private val _uiState = MutableStateFlow<HomeScreenUiState>(HomeScreenUiState.Loading)
      // val uiState: StateFlow<HomeScreenUiState> = _uiState.asStateFlow()
      ```
    * [ ] Update `WorkspaceInitialPhotos()` (and retry logic) to set these states:
        * Start: `_uiState.value = HomeScreenUiState.Loading` (or `_isLoadingInitial=true, _error=null, _photos=empty, _isEmpty=false`).
        * Success with data: `_uiState.value = HomeScreenUiState.Success(mappedPhotos)`.
        * Success with empty data: `_uiState.value = HomeScreenUiState.Empty`.
        * Error: `_uiState.value = HomeScreenUiState.Error(UserFacingError(...))`.
    * [ ] Implement `fun retryInitialLoad()` that calls `WorkspaceInitialPhotos()`.
* [ ] **Modify `HomeScreen.kt` for State Display:**
    * [ ] Collect the `uiState` (or individual states) from `HomeScreenViewModel`.
    * [ ] Use a `Crossfade` or `when` with `AnimatedVisibility` to display content based on `uiState`:
      ```kotlin
      // Crossfade(targetState = uiState, label = "HomeScreenStateCrossfade") { state ->
      //    when (state) {
      //        is HomeScreenUiState.Loading -> CenteredCircularProgressIndicator() // Or ShimmerGridPlaceholder()
      //        is HomeScreenUiState.Success -> LazyVerticalStaggeredGrid(photos = state.photos, ...)
      //        is HomeScreenUiState.Empty -> EmptyStateMessageComposable("No trending photos...")
      //        is HomeScreenUiState.Error -> ErrorView(error = state.error, onRetry = { viewModel.retryInitialLoad() })
      //    }
      // }
      ```
    * [ ] Implement `ShimmerGridPlaceholder()` if that's the chosen loading UI.
    * [ ] Implement `EmptyStateMessageComposable()`.
* [ ] Ensure animations from Story 9.3 are applied to these state transitions.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests (for `HomeScreenViewModel.kt`):**
    * Test state transitions for initial load: Loading -> Success, Loading -> Empty, Loading -> Error.
    * Verify `retryInitialLoad()` correctly re-triggers fetch.
    * Mock `ImageRepository` to return success with data, success with empty list, and error.
* **Integration Tests (UI Tests):**
    * (To be formalized)
    * Test UI displays: loading indicator, then photo grid on success.
    * Test UI displays: loading, then empty message.
    * Test UI displays: loading, then `ErrorView`. Test retry button on `ErrorView`.
    * Verify smooth animated transitions between states.
    * _(Refer to `testing-strategy.md`.)_
* **Manual/CLI Verification:**
    * AC1: On app launch, verify loading indicator/shimmer is shown.
    * AC2: (Hard to test without API control) If API hypothetically returned empty for `/curated`, verify empty message.
    * AC3: Simulate initial load error (e.g., airplane mode on first launch). Verify `ErrorView` appears.
    * AC4: With `ErrorView` shown, enable network, click "Retry". Verify data loads and grid appears.
    * AC5: Visually confirm smooth transitions between loading/content/error/empty states.
* _(Hint: See `testing-strategy.md` and `research-homescreen-trending-photos.md` [State Management section].)_