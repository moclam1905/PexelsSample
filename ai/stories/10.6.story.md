
# Story 10.6: Robust State Handling for HomeScreen (Initial Load, Empty, Error)

**Status:** Draft

## Goal & Context

**User Story:** As a user, I want the `HomeScreen` to clearly communicate its status, whether it's loading initial photos, encounters an error, or if (hypothetically) no trending photos are available.

**Context:** This story ensures the `HomeScreen` (modified to display trending photos) gracefully handles all its primary data states: initial data loading, displaying the photo grid (content), an empty state (if no photos are returned by the `/v1/curated` endpoint), and error states (network/API issues during the initial load). It builds on Story 10.1 (basic loading) and utilizes the `ErrorView` Composable from Epic 5. This aligns with PRD v1.2 [45], [90], [190], [210], [235], [460]-[461], [481], [506] and research [State Management section].

## Detailed Requirements

* `HomeScreenViewModel`'s UI state mechanism (e.g., a sealed `HomeScreenUiState` or individual `StateFlow`s) will comprehensively cover:
  * `isLoadingInitial: Boolean` (for the very first load or after a manual refresh action).
  * `photos: List<Photo>` (the list of trending photos to display).
  * `isEmpty: Boolean` (derived: true if `!isLoadingInitial`, `photos.isEmpty()`, no `error`, and an initial fetch *was* attempted).
  * `error: UserFacingError?` (for errors during the initial load of trending photos).
* **Initial Load State:** When `HomeScreenViewModel.isLoadingInitial` is true (and `photos` list is empty, and no `error`):
  * `HomeScreen` displays a prominent, screen-centered `CircularProgressIndicator` OR a full-screen shimmer placeholder applied to a skeleton grid structure (aligning with Story 10.5's shimmer effect for a more polished loading experience).
* **Empty State:** If the `ImageRepository` returns an empty list for the initial `/v1/curated` photos fetch (and it's not an error, and loading is finished):
  * `HomeScreenViewModel` updates its state so that `isEmpty` (or equivalent in `HomeScreenUiState`) becomes true.
  * `HomeScreen` displays a user-friendly message (e.g., "No trending photos to show right now. Try refreshing!"). The photo grid should be hidden.
* **Error State:** If the initial fetch for trending photos from `ImageRepository` results in an error:
  * `HomeScreenViewModel.errorState` (or `uiState.error`) is populated with a `UserFacingError` object.
  * `HomeScreen` displays a centered `ErrorView` Composable (reused from Story 5.1) containing the error message and a "Retry" button.
  * The "Retry" button calls a `retryInitialLoad()` (or the existing `WorkspaceInitialPhotos()`/`onManualRefreshTriggered()`) function in `HomeScreenViewModel`.
* Use `AnimatedVisibility` or `Crossfade` (as implemented or refined in Story 9.3) to smoothly transition between these primary states (Loading, Content, Empty, Error) on the `HomeScreen`.

## Acceptance Criteria (ACs)

* AC1: A full-screen loading indicator (e.g., centered `CircularProgressIndicator` or a shimmer skeleton grid) is shown on `HomeScreen` when `HomeScreenViewModel.isLoadingInitial` is true, no photos are yet displayed, and no error has occurred.
* AC2: If the initial API call for curated photos successfully returns an empty list (and loading is finished, no error), `HomeScreen` displays a user-friendly "empty state" message (e.g., "No trending photos available at the moment."). The grid is hidden.
* AC3: If the initial data fetch for `HomeScreen` fails (e.g., network error), a full-screen `ErrorView` with a descriptive message and a "Retry" button is displayed. The grid and empty message are hidden.
* AC4: Clicking the "Retry" button on the `ErrorView` triggers `HomeScreenViewModel` to re-attempt fetching the initial set of curated photos.
* AC5: Transitions between the Loading, Content (photo grid), Empty, and Error states on `HomeScreen` are smooth and clear (e.g., using `Crossfade` or `AnimatedVisibility`). Only one of these primary states is predominantly visible at any time.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Story 10.1 (basic `HomeScreen` structure) and Story 10.5 (shimmer effect concept) are relevant. `ErrorView` from Epic 5 (Story 5.1) will be reused. Animation patterns from Epic 9 (Story 9.3) should be applied.

* **Relevant Files:**
  * Files to Modify:
    * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreenViewModel.kt`
    * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreen.kt`
  * _(Hint: `research-homescreen-trending-photos.md` [State Management section]. `coding-standards.md`.)_

* **Key Technologies:**
  * `HomeScreenViewModel` state management (`StateFlow`, `UserFacingError`, potentially a sealed `HomeScreenUiState`).
  * Jetpack Compose: Conditional rendering, `CircularProgressIndicator`, `ErrorView` (reusable), `Text` for empty state, `AnimatedVisibility` or `Crossfade` for transitions.
  * Skeleton loaders / Shimmer effect (from Story 10.5).
  * _(Hint: `tech-stack.md`.)_

* **API Interactions / SDK Usage:**
  * Handles various states resulting from the initial `imageRepository.getCuratedPhotos()` call.
  * _(Hint: `api-reference.md`)_

* **Data Structures:**
  * `HomeScreenViewModel` needs to clearly expose `isLoadingInitial`, `photosList`, `errorState` (for initial load errors), and a way to determine the `isEmpty` state. A combined `UiState` sealed interface/class (`Loading`, `Success(List<Photo>)`, `Error(UserFacingError)`, `Empty`) is highly recommended for managing these mutually exclusive states.
  * _(Hint: See `data-models.md v1.1`.)_

* **Environment Variables:**
  * Not applicable.
  * _(Hint: See `environment-vars.md`)_

* **Coding Standards Notes:**
  * The state representation in `HomeScreenViewModel` should be robust and make it easy for the UI to determine which single state to display.
  * UI (`HomeScreen.kt`) should reactively display only one of these primary states at a time.
  * The "Retry" logic should correctly re-initiate the initial load sequence.
  * Animations between states should be consistent with those defined in Story 9.3.
  * Adhere to `docs/coding-standards.md`.
  * _(Hint: See `docs/coding-standards.md`.)_

## Tasks / Subtasks

* [ ] **Refine `HomeScreenViewModel.kt` State Management:**
  * [ ] Implement or refine a sealed interface for UI state, e.g., `HomeScreenUiState`:
    ```kotlin
    // sealed interface HomeScreenUiState {
    //     data object InitialLoading : HomeScreenUiState // Or just isLoadingInitial flag
    //     data class Content(val photos: List<Photo>) : HomeScreenUiState
    //     data class Error(val errorDetails: UserFacingError) : HomeScreenUiState
    //     data object Empty : HomeScreenUiState // When search attempted, finished, no error, but no photos
    // }
    // private val _uiState = MutableStateFlow<HomeScreenUiState>(HomeScreenUiState.InitialLoading)
    // val uiState: StateFlow<HomeScreenUiState> = _uiState.asStateFlow()
    ```
  * [ ] Update `WorkspaceInitialPhotos()` (and any retry method like `onManualRefreshTriggered` if it also handles initial load retry) to set these states:
    * Start: `_uiState.value = HomeScreenUiState.InitialLoading` (or manage `_isLoadingInitial`, `_photos`, `_errorState` flags to achieve this).
    * On successful API response (`ResultWrapper.Success<PexelsSearchResponseDto>`):
      * If `mappedPhotos.isNotEmpty()`: `_uiState.value = HomeScreenUiState.Content(mappedPhotos)`.
      * If `mappedPhotos.isEmpty()`: `_uiState.value = HomeScreenUiState.Empty`.
    * On API error (`ResultWrapper.GenericError` or `ResultWrapper.NetworkError`):
      * `_uiState.value = HomeScreenUiState.Error(UserFacingError(message = "Failed to load trending photos.", isRetryable = true))`.
  * [ ] Ensure `_isLoadingInitial` (if used separately) is correctly set to `false` after processing success or error.
* [ ] **Modify `HomeScreen.kt` for Comprehensive State Display:**
  * [ ] Collect the primary `uiState` (or individual state flags) from `HomeScreenViewModel`.
  * [ ] Use `Crossfade` (or `AnimatedVisibility` with careful management of mutual exclusivity) to display content based on `uiState`:
    ```kotlin
    // val currentUiState by viewModel.uiState.collectAsStateWithLifecycle()
    // Crossfade(targetState = currentUiState, animationSpec = tween(300), label = "HomeScreenContent") { state ->
    //    when (state) {
    //        HomeScreenUiState.InitialLoading -> {
    //            // CenteredCircularProgressIndicator() OR ShimmerGridPlaceholderComposable()
    //        }
    //        is HomeScreenUiState.Content -> {
    //            LazyVerticalStaggeredGrid(photos = state.photos, ...)
    //        }
    //        HomeScreenUiState.Empty -> {
    //            CenteredMessageComposable("No trending photos to show right now. Try refreshing!")
    //        }
    //        is HomeScreenUiState.Error -> {
    //            ErrorView(error = state.errorDetails, onRetry = { viewModel.fetchInitialPhotos() /* or a dedicated retry function */ })
    //        }
    //    }
    // }
    ```
  * [ ] Implement `ShimmerGridPlaceholderComposable()` if a skeleton loader with shimmer is chosen for the `InitialLoading` state (aligns with Story 10.5).
  * [ ] Implement `CenteredMessageComposable(message: String)` for the `Empty` state.
* [ ] Ensure animations for these state transitions (from Story 9.3) are applied smoothly.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests (for `HomeScreenViewModel.kt`):**
  * Test all state transitions for the initial load sequence:
    * `InitialLoading` -> `Content(data)`.
    * `InitialLoading` -> `Empty`.
    * `InitialLoading` -> `Error(details)`.
  * Verify that the "Retry" action (e.g., calling `WorkspaceInitialPhotos` again) correctly re-initiates the loading sequence and can transition to `Content` if the underlying issue is resolved.
  * Mock `ImageRepository` to return:
    * Success with a non-empty list of photos.
    * Success with an empty list of photos.
    * Network or Generic errors.
* **Integration Tests (UI Tests using Jetpack Compose UI Test):**
  * (To be formalized later)
  * Test `HomeScreen`'s UI reaction to different states emitted by a mocked `HomeScreenViewModel`:
    * Emits `InitialLoading`: Verify loading indicator or shimmer skeleton is displayed.
    * Emits `Content`: Verify `LazyVerticalStaggeredGrid` with photos is displayed.
    * Emits `Empty`: Verify the "empty state" message is displayed.
    * Emits `Error`: Verify `ErrorView` is displayed. Test the "Retry" button functionality by having the mock ViewModel transition to `Loading` then `Content` upon retry.
  * Verify smooth animated transitions between these states if possible with the test framework.
  * _(Refer to `testing-strategy.md`.)_
* **Manual/CLI Verification:**
  * AC1: On first app launch (or after clearing app data), verify the full-screen loading indicator (or shimmer skeleton) is shown while initial trending photos are being fetched.
  * AC2: (Difficult to test without controlling API response) If the `/v1/curated` API endpoint were to hypothetically return an empty list successfully, verify the "No trending photos available..." message is displayed.
  * AC3: Simulate an initial load error (e.g., by launching the app in airplane mode). Verify the `ErrorView` with a relevant message and "Retry" button is displayed.
  * AC4: While the `ErrorView` is shown due to a network error, enable network connectivity and click the "Retry" button. Verify that `HomeScreenViewModel` re-attempts the fetch, the loading indicator shows, and then the photo grid appears if successful.
  * AC5: Visually confirm that transitions between the loading, content grid, empty message, and error view states are smooth (e.g., using `Crossfade` or `AnimatedVisibility`). Ensure only one of these primary states is visible at a time.
* _(Hint: See `testing-strategy.md` and `research-homescreen-trending-photos.md` [State Management section].)_