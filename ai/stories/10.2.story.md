
# Story 10.2: Implement Infinite Scrolling for Trending Photos on HomeScreen

**Status:** Draft

## Goal & Context

**User Story:** As a user, when I scroll to the bottom of the trending photos on the `HomeScreen`, I want more photos to load automatically, so I can continuously discover new content.

**Context:** This story builds on Story 10.1, which established the display of trending photos in a `LazyVerticalStaggeredGrid` on the modified `HomeScreen`. Now, infinite scrolling will be added to fetch and display subsequent pages from the `/v1/curated` Pexels API endpoint. This aligns with PRD v1.2 [37], [182], [453].

## Detailed Requirements

* In `HomeScreen.kt`, use `rememberLazyStaggeredGridState()` and monitor its `layoutInfo.visibleItemsInfo` to detect when the user has scrolled near the end of the currently loaded items.
* When near the end (e.g., last few items visible), and if not already loading more (`HomeScreenViewModel.isLoadingNextPage` is false) and more pages are potentially available (`HomeScreenViewModel.canLoadMoreCurated` is true), call a `loadNextCuratedPage()` function in `HomeScreenViewModel`.
* `HomeScreenViewModel` will manage `currentCuratedPage` for the `/v1/curated` endpoint and call `ImageRepository.getCuratedPhotos(page = nextPage, ...)`.
* New photos fetched are appended to the existing `_photos.value` list in `HomeScreenViewModel`.
* `HomeScreenViewModel` to expose `isLoadingNextPage: StateFlow<Boolean>` and `canLoadMoreCurated: StateFlow<Boolean>`.
* Display a small loading indicator item at the bottom of the `LazyVerticalStaggeredGrid` when `isLoadingNextPage` is true.
* Handle pagination errors from the repository gracefully: if loading the next page fails, display a small error item with a "Retry" option at the end of the list. `isLoadingNextPage` should become false, and `canLoadMoreCurated` might remain true if the error is retryable.

## Acceptance Criteria (ACs)

* AC1: When scrolling near the end of `LazyVerticalStaggeredGrid` on `HomeScreen` and conditions are met, `HomeScreenViewModel.loadNextCuratedPage()` is triggered.
* AC2: `HomeScreenViewModel` exposes and correctly manages `isLoadingNextPage: StateFlow<Boolean>` and `canLoadMoreCurated: StateFlow<Boolean>`.
* AC3: A loading indicator item is visible at the end of the grid while `HomeScreenViewModel.isLoadingNextPage` is true.
* AC4: New photos are appended to the grid seamlessly upon successful loading of the next page.
* AC5: Infinite scrolling is smooth and does not cause significant UI jank.
* AC6: If loading the next page fails, an inline error message with a "Retry" button is shown at the end of the list, and `isLoadingNextPage` is false. Retrying calls `loadNextCuratedPage()` again.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Story 10.1 is complete.

* **Relevant Files:**
    * Files to Modify:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreenViewModel.kt`
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreen.kt`
    * _(Hint: `research-homescreen-trending-photos.md` [Section 4] for infinite scroll UX. `coding-standards.md`.)_

* **Key Technologies:**
    * Jetpack Compose: `rememberLazyStaggeredGridState`, `LazyStaggeredGridState.layoutInfo`, `LaunchedEffect`, `derivedStateOf`.
    * `HomeScreenViewModel`: Logic for pagination, new state flags (`isLoadingNextPage`, `canLoadMoreCurated`, `currentCuratedPage`, `paginationError: StateFlow<UserFacingError?>`).
    * `CircularProgressIndicator`, `Button` (for retry).
    * _(Hint: See `tech-stack.md`.)_

* **API Interactions / SDK Usage:**
    * `HomeScreenViewModel` calls `imageRepository.getCuratedPhotos()` with incrementing page numbers.
    * Pexels API `/v1/curated` has `page` and `per_page` parameters. `next_page` URL in response indicates if more can be loaded.
    * _(Hint: `api-reference.md`.)_

* **Data Structures:**
    * ViewModel states for pagination (`currentCuratedPage`, `isLoadingNextPage`, `canLoadMoreCurated`, `paginationError`).
    * _(Hint: See `data-models.md v1.1`.)_

* **Environment Variables:**
    * Not applicable.
    * _(Hint: See `environment-vars.md`)_

* **Coding Standards Notes:**
    * Scroll detection threshold (buffer) should be configurable or well-chosen.
    * Ensure pagination loading state is distinct from initial loading state (`isLoadingInitial` from `HomeScreenViewModel`).
    * Handle API's indication of no more pages (e.g., `next_page` URL is null in `PexelsSearchResponseDto`).
    * Inline error for pagination is less intrusive than full-screen error.
    * Adhere to `docs/coding-standards.md`.
    * _(Hint: See `coding-standards.md` for full standards.)_

## Tasks / Subtasks

* [ ] **Modify `HomeScreenViewModel.kt`:**
    * [ ] Add state variables:
        * `private var currentCuratedPage = 1` (already part of initial load, now used for pagination).
        * `private val _isLoadingNextPage = MutableStateFlow(false)`, `val isLoadingNextPage: StateFlow<Boolean> = _isLoadingNextPage.asStateFlow()`.
        * `private val _canLoadMoreCurated = MutableStateFlow(true)`, `val canLoadMoreCurated: StateFlow<Boolean> = _canLoadMoreCurated.asStateFlow()`.
        * `private val _paginationError = MutableStateFlow<UserFacingError?>(null)`, `val paginationError: StateFlow<UserFacingError?> = _paginationError.asStateFlow()`.
    * [ ] Modify initial fetch in `WorkspaceInitialPhotos()` (from Story 10.1):
        * Ensure it resets `currentCuratedPage = 1`, `_canLoadMoreCurated.value = true`, `_paginationError.value = null`.
        * On successful API response from `imageRepository.getCuratedPhotos`, update `_canLoadMoreCurated.value = responseData.nextPage != null` (where `responseData` is the `PexelsSearchResponseDto`).
    * [ ] Create `fun loadNextCuratedPage()`:
        * Guard: `if (_isLoadingInitial.value || _isLoadingNextPage.value || !_canLoadMoreCurated.value) return`.
        * Set `_isLoadingNextPage.value = true`, `_paginationError.value = null`.
        * Increment `currentCuratedPage`.
        * `viewModelScope.launch { ... }` to call `imageRepository.getCuratedPhotos(page = currentCuratedPage, perPage = ITEMS_PER_PAGE)`.
        * On success (`ResultWrapper.Success<PexelsSearchResponseDto>`):
            * Map `responseData.photos` to `List<Photo>`.
            * Append new photos: `_photos.value = _photos.value + mappedNewPhotos`.
            * `_canLoadMoreCurated.value = responseData.nextPage != null`.
        * On error (`ResultWrapper.GenericError`, `ResultWrapper.NetworkError`): Set `_paginationError.value` with a retryable `UserFacingError` message.
        * `finally { _isLoadingNextPage.value = false }`.
* [ ] **Modify `HomeScreen.kt`:**
    * [ ] Ensure `gridState = rememberLazyStaggeredGridState()` is used for `LazyVerticalStaggeredGrid`.
    * [ ] Collect `isLoadingInitial`, `isLoadingNextPage`, `canLoadMoreCurated`, `paginationError`, and `photosList` from `viewModel`.
    * [ ] Implement scroll detection logic to trigger `viewModel.loadNextCuratedPage()`:
      ```kotlin
      val buffer = 5 // Number of items from end to trigger load more
      val currentPhotosSize = photosList.size
      val layoutInfo = gridState.layoutInfo
      
      LaunchedEffect(layoutInfo, currentPhotosSize, canLoadMoreCurated, isLoadingInitial, isLoadingNextPage, paginationError) {
          val lastVisibleItemIndex = layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: -1
          if (currentPhotosSize > 0 && lastVisibleItemIndex >= currentPhotosSize - 1 - buffer) {
              if (canLoadMoreCurated && !isLoadingInitial && !isLoadingNextPage && paginationError == null) {
                  viewModel.loadNextCuratedPage()
              }
          }
      }
      ```
    * [ ] Modify `LazyVerticalStaggeredGrid`'s content:
        * After existing `items(photosList, ...)` block, add conditional items for loading indicator or error:
      ```kotlin
        // if (isLoadingNextPage) {
        //     item(span = StaggeredGridItemSpan.FullLine) {
        //         Box(modifier = Modifier.fillMaxWidth().padding(16.dp), contentAlignment = Alignment.Center) {
        //             CircularProgressIndicator()
        //         }
        //     }
        // }
        // paginationError?.let { error ->
        //     if (!isLoadingNextPage) { // Only show if not actively trying to load again
        //         item(span = StaggeredGridItemSpan.FullLine) {
        //             Row(
        //                 modifier = Modifier.fillMaxWidth().padding(16.dp),
        //                 horizontalArrangement = Arrangement.Center,
        //                 verticalAlignment = Alignment.CenterVertically
        //             ) {
        //                 Text(error.message, color = MaterialTheme.colorScheme.error)
        //                 Spacer(Modifier.width(8.dp))
        //                 Button(onClick = { viewModel.loadNextCuratedPage() }) { Text("Retry") }
        //             }
        //         }
        //     }
        // }
      ```

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests (for `HomeScreenViewModel.kt`):**
    * Test `loadNextCuratedPage()`:
        * Correctly increments `currentCuratedPage`.
        * Sets `isLoadingNextPage` true before API call and false after (success/error).
        * Appends new photos to `_photos.value` on successful API response.
        * Correctly updates `canLoadMoreCurated` based on `nextPage` field from API response.
        * Sets `paginationError` state on API failure during pagination.
        * Handles guard conditions effectively (e.g., doesn't load if already loading or `canLoadMoreCurated` is false).
* **Integration Tests (UI Tests):**
    * (To be formalized) Simulate scrolling to the end of the grid.
    * Verify `HomeScreenViewModel.loadNextCuratedPage()` is invoked.
    * Check for the appearance of the loading indicator at the bottom of the grid.
    * Verify new items are appended to the grid, or an inline error message with a retry button appears if the pagination call fails.
    * _(Refer to `testing-strategy.md`.)_
* **Manual/CLI Verification:**
    * AC1: Scroll down the `HomeScreen`. Verify through logs or debugger that `viewModel.loadNextCuratedPage()` is triggered when nearing the end of the list, provided `canLoadMoreCurated` is true and not already loading.
    * AC2: Review `HomeScreenViewModel` code to confirm correct management of `isLoadingNextPage` and `canLoadMoreCurated` states.
    * AC3: When pagination is triggered, observe the loading indicator appearing at the bottom of the `LazyVerticalStaggeredGrid`.
    * AC4: Verify that newly fetched photos are appended to the grid, allowing continuous scrolling.
    * AC5: Assess the smoothness of scrolling and item loading during pagination. Check for any UI jank.
    * AC6: Simulate a network error during a pagination attempt (e.g., turn off internet after initial load but before scrolling to end). Verify that an inline error message and a "Retry" button appear at the end of the list. Test that the "Retry" button re-attempts `loadNextCuratedPage()`.
* _(Hint: See `testing-strategy.md` and `research-homescreen-trending-photos.md` [Section 4].)_
