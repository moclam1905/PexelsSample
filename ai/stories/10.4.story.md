
# Story 10.4: Implement User-Initiated Refresh on HomeScreen

**Status:** Draft

## Goal & Context

**User Story:** As a user, I want a way to manually refresh the list of trending photos on the HomeScreen, so I can see the very latest curated content if I choose.

**Context:** This story adds a manual refresh mechanism to the `HomeScreen` for its trending photos feed. This is distinct from the pull-to-refresh on the search results screen (Epic 8) and provides an explicit way for users to reload the `/v1/curated` content. This aligns with PRD v1.2 [39], [184], [455].

## Detailed Requirements

* Add a "Refresh" `IconButton` to the `HomeScreen`, likely in a `TopAppBar`. This `TopAppBar` will also house the search action icon (from updated Story 10.1).
* Tapping this refresh button calls an `onManualRefreshTriggered()` function in `HomeScreenViewModel`.
* `HomeScreenViewModel.onManualRefreshTriggered()` will:
    * Set an `isRefreshingManual: StateFlow<Boolean>` state to true (this state should be distinct from `isLoadingInitial` and `isLoadingNextPage`).
    * Call `imageRepository.getCuratedPhotos(page = 1, perPage = ITEMS_PER_PAGE)` to fetch the first page, effectively resetting the list.
    * Upon successful fetch:
        * Replace `_photos.value` with the new list.
        * Reset `currentCuratedPage = 1`.
        * Update `_canLoadMoreCurated.value` based on the new response.
        * Clear any existing `_errorState.value` or `_paginationError.value`.
    * On error: Set `_errorState.value` with an appropriate `UserFacingError` for the main screen, or trigger a Snackbar message.
    * Set `isRefreshingManual` to false on completion (success or error) in a `finally` block.
* The refresh `IconButton` should be disabled, or its icon should change to a small `CircularProgressIndicator`, while `isRefreshingManual` is true.
* Provide feedback on completion or failure via a `Snackbar` (e.g., "Trending photos updated" or "Failed to refresh.").

## Acceptance Criteria (ACs)

* AC1: A "Refresh" `IconButton` is present in the `TopAppBar` on `HomeScreen` and is functional.
* AC2: Tapping the refresh button triggers `HomeScreenViewModel` to re-fetch page 1 of curated photos from the `ImageRepository`.
* AC3: Visual feedback (e.g., button disabled, or icon changes to a small progress indicator within the button's space) is provided on the refresh button while `HomeScreenViewModel.isRefreshingManual` is true.
* AC4: The `LazyVerticalStaggeredGrid` on `HomeScreen` is updated with new photos (replacing the old list) upon successful refresh. Pagination state (`currentCuratedPage`, `canLoadMoreCurated`) is reset.
* AC5: A `Snackbar` message confirms success (e.g., "Trending photos updated.") or failure (e.g., "Failed to refresh.") of the manual refresh operation.
* AC6: The `onManualRefreshTriggered()` function in the ViewModel does nothing if `isRefreshingManual.value` or `isLoadingInitial.value` is already true, to prevent concurrent refresh/load operations.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Stories 10.1-10.3 are complete.

* **Relevant Files:**
    * Files to Modify:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreenViewModel.kt`
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreen.kt`
        * `MainActivity.kt` or root Composable (to provide `SnackbarHostState` if not already available globally).
    * _(Hint: `research-homescreen-trending-photos.md` [Section 3]. `coding-standards.md`.)_

* **Key Technologies:**
    * Jetpack Compose: `IconButton`, `Icon`, `TopAppBar`, `CircularProgressIndicator` (small for button), `SnackbarHost`, `SnackbarHostState`, `Scaffold`.
    * `HomeScreenViewModel` state (`isRefreshingManual`, `errorState`).
    * Material Symbols for refresh icon (e.g., `Icons.Filled.Refresh`).
    * Kotlin Coroutines (`viewModelScope`, `SharedFlow` for Snackbar messages).
    * _(Hint: See `tech-stack.md`.)_

* **API Interactions / SDK Usage:**
    * Triggers `imageRepository.getCuratedPhotos(page = 1, perPage = ITEMS_PER_PAGE)`.
    * _(Hint: `api-reference.md`)_

* **Data Structures:**
    * `isRefreshingManual: StateFlow<Boolean>` in `HomeScreenViewModel`.
    * A `SharedFlow<String>` or similar event mechanism in `HomeScreenViewModel` for one-time Snackbar messages.
    * _(Hint: See `data-models.md v1.1`.)_

* **Environment Variables:**
    * Not applicable.
    * _(Hint: See `environment-vars.md`)_

* **Coding Standards Notes:**
    * Ensure the manual refresh loading state (`isRefreshingManual`) is distinct from initial load (`isLoadingInitial`) and pagination load (`isLoadingNextPage`).
    * Provide clear visual feedback for the refresh action.
    * Snackbar messages should be concise and informative.
    * Adhere to `docs/coding-standards.md`.
    * _(Hint: See `docs/coding-standards.md`.)_

## Tasks / Subtasks

* [ ] **Modify `HomeScreenViewModel.kt`:**
    * [ ] Add `private val _isRefreshingManual = MutableStateFlow(false)`, `val isRefreshingManual: StateFlow<Boolean> = _isRefreshingManual.asStateFlow()`.
    * [ ] Add `private val _snackbarMessage = MutableSharedFlow<String>()`, `val snackbarMessage: SharedFlow<String> = _snackbarMessage.asSharedFlow()`.
    * [ ] Create `fun onManualRefreshTriggered()`:
        * Guard: `if (_isLoadingInitial.value || _isRefreshingManual.value || _isLoadingNextPage.value) return`.
        * Set `_isRefreshingManual.value = true`.
        * Clear main `_errorState.value = null` (as this refresh might fix it or cause a new one for Snackbar).
        * `viewModelScope.launch { ... }`:
            * `try`:
                * Call `imageRepository.getCuratedPhotos(page = 1, perPage = ITEMS_PER_PAGE)`.
                * On success (`ResultWrapper.Success<PexelsSearchResponseDto>`):
                    * `currentCuratedPage = 1`.
                    * `_photos.value = mappedNewPhotos`.
                    * `_canLoadMoreCurated.value = responseData.nextPage != null`.
                    * `_snackbarMessage.emit("Trending photos updated.")`.
                * On error (`ResultWrapper.GenericError`, `ResultWrapper.NetworkError`):
                    * `_snackbarMessage.emit("Failed to refresh. ${error.message ?: ""}")`.
                    * (Optionally, if error is critical and list becomes empty, set main `_errorState` for `ErrorView`).
            * `finally { _isRefreshingManual.value = false }`.
* [ ] **Modify `HomeScreen.kt`:**
    * [ ] Ensure `Scaffold` is used, and get `snackbarHostState = remember { SnackbarHostState() }`. Add `SnackbarHost(hostState = snackbarHostState)` to `Scaffold`.
    * [ ] In `TopAppBar`'s `actions`:
      ```kotlin
      // val isRefreshingManual by viewModel.isRefreshingManual.collectAsStateWithLifecycle()
      // val isLoadingInitial by viewModel.isLoadingInitial.collectAsStateWithLifecycle()
      // IconButton(
      //     onClick = { viewModel.onManualRefreshTriggered() },
      //     enabled = !isRefreshingManual && !isLoadingInitial 
      // ) {
      //     if (isRefreshingManual) {
      //         CircularProgressIndicator(modifier = Modifier.size(24.dp), strokeWidth = 2.dp)
      //     } else {
      //         Icon(Icons.Filled.Refresh, contentDescription = "Refresh Trending Photos")
      //     }
      // }
      // // ... other actions like search icon ...
      ```
    * [ ] Use `LaunchedEffect` to listen to `viewModel.snackbarMessage` and show SnackBar:
      ```kotlin
      // LaunchedEffect(key1 = viewModel) { // Use a key that doesn't change often unless you want re-subscription logic
      //     viewModel.snackbarMessage.collect { message ->
      //         snackbarHostState.showSnackbar(message, duration = SnackbarDuration.Short)
      //     }
      // }
      ```

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests (for `HomeScreenViewModel.kt`):**
    * Test `onManualRefreshTriggered()`:
        * Verifies `isRefreshingManual` state changes correctly.
        * Calls `imageRepository.getCuratedPhotos(page = 1)`.
        * Updates `_photos` list and resets pagination state (`currentCuratedPage`, `canLoadMoreCurated`) on success.
        * Emits correct Snackbar message via `_snackbarMessage` flow on success or failure.
        * Sets main `_errorState` if applicable on critical failure.
        * Handles guard conditions (doesn't run if already loading/refreshing).
* **Integration Tests (UI Tests):**
    * (To be formalized) Tap the refresh button.
    * Verify `HomeScreenViewModel.onManualRefreshTriggered()` is called.
    * Verify UI feedback on the button (disabled state or progress indicator).
    * Verify a `Snackbar` message appears upon completion (success or failure).
    * Verify the `LazyVerticalStaggeredGrid` updates with new data on success.
    * _(Refer to `testing-strategy.md`.)_
* **Manual/CLI Verification:**
    * AC1: Verify the refresh `IconButton` is visible and enabled in the `TopAppBar` of `HomeScreen`.
    * AC2: Tap the refresh button. Use logs/debugger to confirm `HomeScreenViewModel` initiates a fetch for page 1 of curated photos.
    * AC3: While the refresh is in progress, verify the refresh button is disabled or shows a small progress indicator.
    * AC4: Upon successful refresh, verify the `LazyVerticalStaggeredGrid` updates to show the new set of photos. Confirm that if you scroll down, pagination starts from this new page 1.
    * AC5: Verify a `Snackbar` appears indicating "Trending photos updated." on success. Simulate a network error, trigger refresh, and verify a failure `Snackbar` (e.g., "Failed to refresh.").
    * AC6: Try tapping the refresh button rapidly or while an initial load is in progress. Verify only one refresh operation proceeds at a time.
* _(Hint: See `testing-strategy.md` and `research-homescreen-trending-photos.md` [Section 3].)_