
# Story 10.4: Implement User-Initiated Refresh on HomeScreen

**Status:** Draft

## Goal & Context

**User Story:** As a user, I want a way to manually refresh the list of trending photos on the HomeScreen, so I can see the very latest curated content if I choose.

**Context:** This story adds a manual refresh mechanism to the `HomeScreen`, distinct from pull-to-refresh (which is on the search results screen). It provides users explicit control to reload the trending photos. This aligns with PRD v1.2 [39], [184], [455].

## Detailed Requirements

* Add a "Refresh" `IconButton` to the `HomeScreen`, likely in a `TopAppBar` or as a Floating Action Button (FAB) if more prominent. *Decision: Place in `TopAppBar` for consistency if search action is also there.*
* Tapping this button calls an `onManualRefreshTriggered()` function in `HomeScreenViewModel`.
* `HomeScreenViewModel.onManualRefreshTriggered()` will:
    * Set an `isRefreshingManual: StateFlow<Boolean>` state to true (distinct from initial load and pagination loading).
    * Call `imageRepository.getCuratedPhotos(page = 1, ...)` to fetch the first page, effectively resetting the list.
    * Update the `_photos.value` list and reset pagination state (`currentCuratedPage = 1`, update `_canLoadMoreCurated`).
    * Set `isRefreshingManual` to false on completion (success or error).
    * Handle errors by setting `_errorState.value`.
* The refresh `IconButton` should be disabled or visually indicate activity (e.g., by replacing icon with `CircularProgressIndicator` of small size) while `isRefreshingManual` is true.
* Provide feedback on completion or failure via a `Snackbar` (e.g., "Trending photos updated" or "Failed to refresh.").

## Acceptance Criteria (ACs)

* AC1: A "Refresh" `IconButton` is present (e.g., in `TopAppBar`) and functional on `HomeScreen`.
* AC2: Tapping the refresh button triggers `HomeScreenViewModel` to re-fetch page 1 of curated photos.
* AC3: Visual feedback (e.g., button disabled, or icon changes to a small progress indicator) is provided on the refresh button while `HomeScreenViewModel.isRefreshingManual` is true.
* AC4: The `LazyVerticalStaggeredGrid` is updated with new photos, replacing the old list, upon successful refresh. Pagination state is reset.
* AC5: A `Snackbar` message confirms success ("Trending photos updated.") or failure ("Failed to refresh.") of the manual refresh operation.
* AC6: `onManualRefreshTriggered()` does nothing if `isRefreshingManual.value` (or `isLoadingInitial.value`) is already true.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Stories 10.1-10.3 are complete.

* **Relevant Files:**
    * Files to Modify:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreenViewModel.kt`
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreen.kt`
        * `MainActivity.kt` or root Composable (for `SnackbarHostState` if not already global).
    * _(Hint: `research-homescreen-trending-photos.md` [Section 3]. `coding-standards.md`.)_

* **Key Technologies:**
    * Jetpack Compose: `IconButton`, `Icon`, `TopAppBar`, `CircularProgressIndicator` (small), `SnackbarHost`, `SnackbarHostState`.
    * `HomeScreenViewModel` state (`isRefreshingManual`, error handling).
    * Material Symbols for refresh icon (e.g., `Icons.Filled.Refresh`).
    * _(Hint: See `tech-stack.md`.)_

* **API Interactions / SDK Usage:**
    * Triggers `imageRepository.getCuratedPhotos(page = 1, ...)`.
    * _(Hint: `api-reference.md`)_

* **Data Structures:**
    * `isRefreshingManual: StateFlow<Boolean>` in ViewModel.
    * _(Hint: See `data-models.md v1.1`.)_

* **Environment Variables:**
    * Not applicable.
    * _(Hint: See `environment-vars.md`)_

* **Coding Standards Notes:**
    * Ensure manual refresh state is distinct from other loading states.
    * Provide clear visual feedback during and after refresh.
    * Snackbar messages should be concise.
    * Adhere to `docs/coding-standards.md`.
    * _(Hint: See `docs/coding-standards.md`.)_

## Tasks / Subtasks

* [ ] **Modify `HomeScreenViewModel.kt`:**
    * [ ] Add `private val _isRefreshingManual = MutableStateFlow(false)`, `val isRefreshingManual: StateFlow<Boolean> = _isRefreshingManual.asStateFlow()`.
    * [ ] Create `fun onManualRefreshTriggered()`:
        * Guard: `if (_isLoadingInitial.value || _isRefreshingManual.value || _isLoadingNextPage.value) return`.
        * Set `_isRefreshingManual.value = true`, `_errorState.value = null`.
        * `viewModelScope.launch { ... }` for API call (similar to `WorkspaceInitialPhotos` but using `_isRefreshingManual` flag and specific Snackbar messages via a new event Flow or by setting a temporary message state).
            * On success: reset `currentCuratedPage=1`, update `_photos`, update `_canLoadMoreCurated`, set success message for Snackbar.
            * On error: set `_errorState` (if it's a critical error preventing display) or set error message for Snackbar.
            * `finally { _isRefreshingManual.value = false }`.
    * [ ] Consider a `SharedFlow<String>` for Snackbar messages from ViewModel.
* [ ] **Modify `HomeScreen.kt`:**
    * [ ] Add a `TopAppBar` to the `Scaffold` if not present.
    * [ ] Add a refresh `IconButton` to `TopAppBar`'s `actions`:
      ```kotlin
      // val isRefreshingManual by viewModel.isRefreshingManual.collectAsStateWithLifecycle()
      // IconButton(
      //     onClick = { viewModel.onManualRefreshTriggered() },
      //     enabled = !isRefreshingManual && !isLoadingInitial // Also consider isLoadingInitial
      // ) {
      //     if (isRefreshingManual) {
      //         CircularProgressIndicator(modifier = Modifier.size(24.dp), strokeWidth = 2.dp)
      //     } else {
      //         Icon(Icons.Filled.Refresh, contentDescription = "Refresh Trending Photos")
      //     }
      // }
      ```
    * [ ] Set up `SnackbarHostState` and `SnackbarHost` (if not globally available from `MainActivity`).
    * [ ] `LaunchedEffect` to observe ViewModel's Snackbar message `SharedFlow` (or error state if used for this) and show SnackBar.
      ```kotlin
      // LaunchedEffect(Unit) { // Or key on a specific event state
      //    viewModel.snackbarMessages.collect { message ->
      //        snackbarHostState.showSnackbar(message, duration = SnackbarDuration.Short)
      //    }
      // }
      ```

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests (for `HomeScreenViewModel.kt`):**
    * Test `onManualRefreshTriggered()`:
        * Verifies `isRefreshingManual` state changes.
        * Calls repository for page 1.
        * Updates `photos` and pagination state on success.
        * Sets error/Snackbar message on failure.
        * Handles guard conditions.
* **Integration Tests (UI Tests):**
    * (To be formalized) Tap refresh button. Verify ViewModel action triggered. Verify UI feedback (disabled/progress on button). Verify Snackbar on completion. Verify list updates.
    * _(Refer to `testing-strategy.md`.)_
* **Manual/CLI Verification:**
    * AC1: Verify refresh icon is visible on `HomeScreen` (e.g., in `TopAppBar`).
    * AC2: Tap refresh. Verify (logs/debugger) ViewModel fetches page 1 curated photos.
    * AC3: While refreshing, verify button shows progress or is disabled.
    * AC4: On success, verify grid updates and pagination would start from page 1 again.
    * AC5: Verify Snackbar appears for success ("Trending photos updated.") or failure ("Failed to refresh.").
    * AC6: Try tapping refresh while initial load or another refresh is in progress; verify it's ignored.
* _(Hint: See `testing-strategy.md` and `research-homescreen-trending-photos.md` [Section 3].)_