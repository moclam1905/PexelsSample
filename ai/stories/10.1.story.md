
# Story 10.1: Integrate LazyVerticalStaggeredGrid into HomeScreen for Trending Photos

**Status:** Draft

## Goal & Context

**User Story:** As a user, when I open the app, I want to see a visually appealing grid of trending photos on the `HomeScreen`, so I can immediately start discovering interesting images.

**Context:** This is the foundational story for Epic 10, **integrating the Trending Photos feature into the existing `HomeScreen`**, making it the primary entry point of the application. `HomeScreen` will now prominently display curated photos from the Pexels API (`/v1/curated`) using Jetpack Compose's `LazyVerticalStaggeredGrid` for a dynamic layout. This aligns with PRD v1.2 Goal 7 ([157], [428]) and uses insights from `research-homescreen-trending-photos.md`. The existing search functionality previously central to `HomeScreen` will be modified to be accessible from here (e.g., via a search icon in the `TopAppBar`).

## Detailed Requirements

* **Modify `HomeScreen.kt`** in the `ui.home` package. This screen will remain the start destination in the navigation graph but will now prioritize displaying trending photos.
* Create `HomeScreenViewModel.kt` in `ui.home`, injected by Hilt. It will use `ImageRepository` to fetch curated photos (Pexels API `/v1/curated`).
* `HomeScreenViewModel` to expose UI state (e.g., `StateFlow<HomeScreenUiState>` containing `isLoadingInitial: Boolean`, `photos: List<Photo>`, `errorMessage: String?`). (A simple `StateFlow<List<Photo>>` and `StateFlow<Boolean>` for initial loading might suffice for this story, with more complex state for errors/empty in Story 10.6).
* `HomeScreen` will display photos using Jetpack Compose's `LazyVerticalStaggeredGrid` from `androidx.compose.foundation.lazy.staggeredgrid`.
* Each grid item will be an `ImageItem` Composable (reused/adapted from search results, Story 3.2), loading an appropriate image size (e.g., `Photo.src.large` or `Photo.src.medium`) using Coil.
* The previous search input UI on `HomeScreen` (from Epic 2) will be refactored:
    * The search bar/input field will be removed from the main content area of `HomeScreen`.
    * A search action (e.g., an `IconButton` with a search icon) will be added to the `TopAppBar` of `HomeScreen`.
    * Tapping this search action will navigate the user to the screen primarily responsible for search input and results (e.g., `AdaptiveSearchResultsHostScreen` or the existing `SearchResultsScreen` if `AdaptiveSearchResultsHostScreen` isn't implemented yet or is the same).

## Acceptance Criteria (ACs)

* AC1: `HomeScreen.kt` is **modified** to feature the `LazyVerticalStaggeredGrid` of trending photos as its primary content. It remains the `startDestination` in `AppNavigation.kt`.
* AC2: `HomeScreenViewModel.kt` is created, Hilt-injected, and fetches the first page of curated photos from `ImageRepository` (which calls Pexels API `/v1/curated`) upon initialization.
* AC3: `HomeScreenViewModel` exposes `StateFlow<List<Photo>>` (for the photos) and `StateFlow<Boolean>` (for `isLoadingInitial`).
* AC4: `HomeScreen` observes the `photos` and `isLoadingInitial` states from `HomeScreenViewModel`.
* AC5: `HomeScreen` displays the fetched photos in a `LazyVerticalStaggeredGrid`. Each item uses the existing `ImageItem` Composable.
* AC6: Images are loaded via Coil within `ImageItem`, and the staggered layout correctly displays images of varying aspect ratios.
* AC7: A basic loading indicator is shown if `isLoadingInitial` is true and the photo list is empty.
* AC8: The `HomeScreen`'s `TopAppBar` now contains a search `IconButton` that, when tapped, navigates to the designated search screen (e.g., `AdaptiveSearchResultsHostScreen`). The previous direct search input UI is removed from `HomeScreen`'s main content.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Epics 1-9 are complete.

* **Relevant Files:**
    * Files to Create:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreenViewModel.kt`
        * Potentially a `HomeScreenUiState.kt` data class/sealed interface if a more complex state object is used from the start.
    * Files to Modify:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreen.kt` (Significant modification to change its primary role).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/core/navigation/AppNavigation.kt` (Ensure `HomeScreen` is `startDestination` and navigation to search screen from `HomeScreen`'s search icon is correctly configured).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/domain/repository/ImageRepository.kt` (to ensure `getCuratedPhotos` method exists).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/data/repository/ImageRepositoryImpl.kt` (to implement `getCuratedPhotos`).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/data/remote/PexelsApiService.kt` (to ensure `/v1/curated` endpoint method exists).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/common/ImageItem.kt` (if any adaptation is needed for staggered grid, though likely reusable as is).
    * _(Hint: `project-structure.md` shows new `HomeScreenViewModel` and notes `HomeScreen` modifications. `architecture.md` describes its role. PRD [35], [180], [451]. `research-homescreen-trending-photos.md` [Section 1].)_

* **Key Technologies:**
    * Jetpack Compose: `LazyVerticalStaggeredGrid`, `LazyStaggeredGridCells.Fixed` or `LazyStaggeredGridCells.Adaptive`, `Scaffold`, `TopAppBar`, `IconButton`.
    * `androidx.compose.foundation.lazy.staggeredgrid.*`
    * Hilt (`@HiltViewModel`).
    * ViewModel, `StateFlow`, Kotlin Coroutines (`viewModelScope`).
    * `ImageRepository` (fetching curated photos).
    * `PexelsApiService` (`/v1/curated` endpoint - see `api-reference.md`).
    * Coil (for image loading in `ImageItem`).
    * `Photo` domain model.
    * Material Symbols (for search icon).
    * _(Hint: `tech-stack.md v1.2` lists `LazyVerticalStaggeredGrid`.)_

* **API Interactions / SDK Usage:**
    * `HomeScreenViewModel` will call `imageRepository.getCuratedPhotos(page: Int, perPage: Int)`.
    * `ImageRepository` will call `pexelsApiService.getCuratedPhotos(...)` which maps to `GET /v1/curated`. (Source: `api-reference.md`)
    * _(Hint: `api-reference.md` details `/v1/curated` endpoint.)_

* **Data Structures:**
    * `HomeScreenViewModel` state: `StateFlow<List<Photo>>`, `StateFlow<Boolean>` for loading.
    * `Photo` domain model objects displayed in the grid.
    * _(Hint: `data-models.md v1.1` for `Photo`.)_

* **Environment Variables:**
    * `PEXELS_API_KEY` (used by `PexelsApiService`).
    * _(Hint: See `environment-vars.md`)_

* **Coding Standards Notes:**
    * `HomeScreenViewModel` should handle initial data load in `init` block or a dedicated function.
    * Use `ITEMS_PER_PAGE` constant (e.g., 20-30) for API calls.
    * `ImageItem` should be flexible enough for staggered grid.
    * Refer to `coding-standards.md v1.2` section on "Jetpack Compose Best Practices" for `LazyVerticalStaggeredGrid`.
    * Navigation from the new search icon should be clear and lead to the established search flow.
    * _(Hint: See `coding-standards.md v1.2` for full standards.)_

## Tasks / Subtasks

* [ ] **Update `PexelsApiService.kt`:**
    * [ ] Ensure a method for `GET /v1/curated` exists, returning `Response<PexelsSearchResponseDto>`.
* [ ] **Update `ImageRepository.kt` (Interface) and `ImageRepositoryImpl.kt`:**
    * [ ] Add/Ensure `suspend fun getCuratedPhotos(page: Int, perPage: Int): ResultWrapper<PexelsSearchResponseDto>` (or similar `Photo` list wrapper).
    * [ ] `ImageRepositoryImpl` implements this.
* [ ] **Create `HomeScreenViewModel.kt`:**
    * [ ] Annotate `@HiltViewModel`, inject `ImageRepository`.
    * [ ] Define `_photos`, `photos`, `_isLoadingInitial`, `isLoadingInitial`, `_errorState` states.
    * [ ] Define `ITEMS_PER_PAGE`.
    * [ ] Create `private fun fetchInitialPhotos()` for initial data load.
    * [ ] Call `WorkspaceInitialPhotos()` in `init {}`.
* [ ] **Modify `HomeScreen.kt`:**
    * [ ] Inject `viewModel: HomeScreenViewModel = hiltViewModel()`. Ensure it accepts `navController` and `windowSizeClass`.
    * [ ] Collect necessary states from `viewModel`.
    * [ ] Update `Scaffold` structure:
        * `TopAppBar`: Set title (e.g., "Trending Photos" or app name). Add an `actions` slot containing an `IconButton` with a search icon (e.g., `Icons.Filled.Search`). The `onClick` for this icon should use `navController` to navigate to the search screen (e.g., `ScreenRoutes.ADAPTIVE_SEARCH_RESULTS_HOST` or the relevant route where search input is now primarily handled).
    * [ ] Main content area:
        * If `isLoading && photosList.isEmpty()`, display a centered `CircularProgressIndicator()`.
        * Else if `photosList.isNotEmpty()`, display `LazyVerticalStaggeredGrid` as previously detailed.
            * `columns` will be determined by `windowSizeClass` (Story 10.3, for now use fixed 2).
            * `items(photosList, key = { photo -> photo.id }) { photo -> ImageItem(photo = photo, onItemClick = { /* Nav to detail: Story 10.7 */ }) }`.
    * [ ] Remove the previous search input field UI from `HomeScreen`'s main content.
* [ ] **Update `AppNavigation.kt`:**
    * [ ] Confirm `HomeScreen` is the `startDestination` and receives `windowSizeClass`.
    * [ ] Verify the navigation route triggered by the new search icon on `HomeScreen` correctly leads to the screen handling search functionality.
* [ ] Test initial load, display in staggered grid, and that the new search icon navigates correctly.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests:**
    * `HomeScreenViewModel`: Mock `ImageRepository`. Test initial photos fetch: verify `isLoadingInitial` states, `photos` state updates on success, error state on failure.
    * `ImageRepositoryImpl`: Test `getCuratedPhotos` method logic (mock `PexelsApiService`).
* **Integration Tests (UI Tests using Jetpack Compose UI Test):**
    * (To be formalized later) Test `HomeScreen` displays `LazyVerticalStaggeredGrid` with items when ViewModel provides data. Test loading indicator visibility. Test search icon navigates to the correct search screen.
    * _(Refer to `testing-strategy.md v1.2` for HomeScreen UI test considerations.)_
* **Manual/CLI Verification:**
    * AC1: Run app. Verify `HomeScreen` is the first screen and now displays (or attempts to load) a grid of photos.
    * AC2: Verify (via logs/debugger) `HomeScreenViewModel` is created and calls `imageRepository.getCuratedPhotos`.
    * AC3, AC4: Confirm ViewModel exposes `photos` and `isLoadingInitial` states, and `HomeScreen` observes them.
    * AC7: While loading, verify a loading indicator is shown.
    * AC5, AC6: After loading, verify photos are displayed in a `LazyVerticalStaggeredGrid`. Check images of different aspect ratios are rendered correctly by Coil within `ImageItem`.
    * AC8: Verify the search input field is gone from `HomeScreen`'s main content. Verify a search icon is present in the `TopAppBar`. Click the search icon and confirm it navigates to the screen where search can be performed.
* _(Hint: See `testing-strategy.md v1.2` and `research-homescreen-trending-photos.md`.)_

