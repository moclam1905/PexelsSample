
# Story 10.1: Implement HomeScreen with LazyVerticalStaggeredGrid for Trending Photos

**Status:** Draft

## Goal & Context

**User Story:** As a user, when I open the app, I want to see a visually appealing grid of trending photos on the HomeScreen, so I can immediately start discovering interesting images.

**Context:** This is the foundational story for Epic 10, establishing the new `HomeScreen` as the app's entry point. It will display curated photos from the Pexels API (`/v1/curated`) using Jetpack Compose's `LazyVerticalStaggeredGrid` for a dynamic layout. This aligns with PRD v1.2 Goal 7 ([157], [428]) and uses insights from `research-homescreen-trending-photos.md`.

## Detailed Requirements

* Create `HomeScreen.kt` in the `ui.home` package. This screen will be the new start destination in the navigation graph.
* Create `HomeScreenViewModel.kt` in `ui.home`, injected by Hilt. It will use `ImageRepository` to fetch curated photos (Pexels API `/v1/curated`).
* `HomeScreenViewModel` to expose UI state (e.g., `StateFlow<HomeScreenUiState>` containing `isLoadingInitial: Boolean`, `photos: List<Photo>`, `errorMessage: String?`). (A simple `StateFlow<List<Photo>>` and `StateFlow<Boolean>` for initial loading might suffice for this story, with more complex state for errors/empty in Story 10.6).
* `HomeScreen` will display photos using Jetpack Compose's `LazyVerticalStaggeredGrid` from `androidx.compose.foundation.lazy.staggeredgrid`.
* Each grid item will be an `ImageItem` Composable (reused/adapted from search results, Story 3.2), loading an appropriate image size (e.g., `Photo.src.large` or `Photo.src.medium`) using Coil.

## Acceptance Criteria (ACs)

* AC1: `HomeScreen.kt` is created and set as the `startDestination` in `AppNavigation.kt`.
* AC2: `HomeScreenViewModel.kt` is created, Hilt-injected, and fetches the first page of curated photos from `ImageRepository` (which calls Pexels API `/v1/curated`) upon initialization.
* AC3: `HomeScreenViewModel` exposes `StateFlow<List<Photo>>` (for the photos) and `StateFlow<Boolean>` (for `isLoadingInitial`).
* AC4: `HomeScreen` observes the `photos` and `isLoadingInitial` states from `HomeScreenViewModel`.
* AC5: `HomeScreen` displays the fetched photos in a `LazyVerticalStaggeredGrid`. Each item uses the existing `ImageItem` Composable.
* AC6: Images are loaded via Coil within `ImageItem`, and the staggered layout correctly displays images of varying aspect ratios.
* AC7: A basic loading indicator is shown if `isLoadingInitial` is true and the photo list is empty.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Epics 1-9 are complete.

* **Relevant Files:**
    * Files to Create:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreen.kt`
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/home/HomeScreenViewModel.kt`
        * Potentially a `HomeScreenUiState.kt` data class/sealed interface if a more complex state object is used from the start.
    * Files to Modify:
        * `app/src/main/java/com/nguyenmoclam/pexelssample/core/navigation/AppNavigation.kt` (to change `startDestination`).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/domain/repository/ImageRepository.kt` (to ensure `getCuratedPhotos` method exists).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/data/repository/ImageRepositoryImpl.kt` (to implement `getCuratedPhotos`).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/data/remote/PexelsApiService.kt` (to ensure `/v1/curated` endpoint method exists).
        * `app/src/main/java/com/nguyenmoclam/pexelssample/ui/common/ImageItem.kt` (if any adaptation is needed for staggered grid, though likely reusable as is).
    * _(Hint: `project-structure.md` shows new `HomeScreenViewModel`. `architecture.md` describes its role. PRD [35], [180], [451]. `research-homescreen-trending-photos.md` [Section 1].)_

* **Key Technologies:**
    * Jetpack Compose: `LazyVerticalStaggeredGrid`, `LazyStaggeredGridCells.Fixed` or `LazyStaggeredGridCells.Adaptive`.
    * `androidx.compose.foundation.lazy.staggeredgrid.*`
    * Hilt (`@HiltViewModel`).
    * ViewModel, `StateFlow`, Kotlin Coroutines (`viewModelScope`).
    * `ImageRepository` (fetching curated photos).
    * `PexelsApiService` (`/v1/curated` endpoint - see `api-reference.md`).
    * Coil (for image loading in `ImageItem`).
    * `Photo` domain model.
    * _(Hint: `tech-stack.md` lists `LazyVerticalStaggeredGrid`.)_

* **API Interactions / SDK Usage:**
    * `HomeScreenViewModel` will call `imageRepository.getCuratedPhotos(page: Int, perPage: Int)`.
    * `ImageRepository` will call `pexelsApiService.getCuratedPhotos(...)` which maps to `GET /v1/curated`. (Source: `api-reference.md`)
    * _(Hint: `api-reference.md` details `/v1/curated` endpoint.)_

* **Data Structures:**
    * `HomeScreenViewModel` state: `StateFlow<List<Photo>>`, `StateFlow<Boolean>` for loading.
    * `Photo` domain model objects displayed in the grid.
    * _(Hint: `data-models.md v1.1` for `Photo`.)_

* **Environment Variables:**
    * `PEXELS_API_KEY` (used by `PexelsApiService`).
    * _(Hint: See `environment-vars.md`)_

* **Coding Standards Notes:**
    * `HomeScreenViewModel` should handle initial data load in `init` block or a dedicated function.
    * Use `ITEMS_PER_PAGE` constant (e.g., 20-30) for API calls.
    * `ImageItem` should be flexible enough for staggered grid (variable heights will come from image aspect ratios naturally if width is constrained by column).
    * Refer to `coding-standards.md` section on "Jetpack Compose Best Practices" for `LazyVerticalStaggeredGrid`.
    * _(Hint: See `coding-standards.md` for full standards.)_

## Tasks / Subtasks

* [ ] **Update `PexelsApiService.kt`:**
    * [ ] Ensure a method for `GET /v1/curated` exists, returning `Response<PexelsSearchResponseDto>` (it's structurally same as search results).
      ```kotlin
      // @GET("curated")
      // suspend fun getCuratedPhotos(
      //     @Query("page") page: Int,
      //     @Query("per_page") perPage: Int
      // ): Response<PexelsSearchResponseDto>
      ```
* [ ] **Update `ImageRepository.kt` (Interface) and `ImageRepositoryImpl.kt`:**
    * [ ] Add/Ensure `suspend fun getCuratedPhotos(page: Int, perPage: Int): ResultWrapper<PexelsSearchResponseDto>` (or similar `Photo` list wrapper).
    * [ ] `ImageRepositoryImpl` implements this by calling the new `PexelsApiService` method and mapping DTOs to domain models.
* [ ] **Create `HomeScreenViewModel.kt`:**
    * [ ] Annotate `@HiltViewModel`, inject `ImageRepository`.
    * [ ] Define `private val _photos = MutableStateFlow<List<Photo>>(emptyList())`, `val photos: StateFlow<List<Photo>> = _photos.asStateFlow()`.
    * [ ] Define `private val _isLoadingInitial = MutableStateFlow(true)`, `val isLoadingInitial: StateFlow<Boolean> = _isLoadingInitial.asStateFlow()`.
    * [ ] Define `private val _errorState = MutableStateFlow<UserFacingError?>(null)` for future use (Story 10.6).
    * [ ] Define `ITEMS_PER_PAGE` constant (e.g., 20).
    * [ ] Create `private fun fetchInitialPhotos()` method:
        * Sets `_isLoadingInitial.value = true`, clears `_errorState`.
        * Calls `imageRepository.getCuratedPhotos(page = 1, perPage = ITEMS_PER_PAGE)`.
        * On success, updates `_photos.value` with mapped results, sets `_isLoadingInitial.value = false`.
        * On error, sets `_errorState.value` (for Story 10.6), sets `_isLoadingInitial.value = false`.
    * [ ] Call `WorkspaceInitialPhotos()` in `init { }` block.
* [ ] **Create `HomeScreen.kt`:**
    * [ ] Annotate `@Composable`, accept `navController: NavController`, `windowSizeClass: WindowSizeClass`.
    * [ ] Inject `viewModel: HomeScreenViewModel = hiltViewModel()`.
    * [ ] Collect `photosList by viewModel.photos.collectAsStateWithLifecycle()`.
    * [ ] Collect `isLoading by viewModel.isLoadingInitial.collectAsStateWithLifecycle()`.
    * [ ] Implement basic structure: `Scaffold` with a `TopAppBar` (title "Trending Photos", optional search icon for later navigation to search screen, refresh icon for Story 10.4).
    * [ ] If `isLoading && photosList.isEmpty()`, display a centered `CircularProgressIndicator()`.
    * [ ] Else if `photosList.isNotEmpty()`, display `LazyVerticalStaggeredGrid`.
        * `columns = StaggeredGridCells.Fixed(determineColumnCount(windowSizeClass))` (column logic in Story 10.3). For now, use fixed 2.
        * `modifier = Modifier.fillMaxSize()`.
        * `contentPadding`, `verticalItemSpacing`, `horizontalArrangement` (as per Story 10.5).
        * `items(photosList, key = { photo -> photo.id }) { photo -> ImageItem(photo = photo, onItemClick = { /* Nav to detail: Story 10.7 */ }) }`.
    * [ ] (Error/Empty states will be added in Story 10.6).
* [ ] **Update `AppNavigation.kt`:**
    * [ ] Set `HomeScreen` as the `startDestination`. Ensure it receives `windowSizeClass`.
* [ ] Test initial load and display in the staggered grid.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

* **Unit Tests:**
    * `HomeScreenViewModel`: Mock `ImageRepository`. Test initial photos fetch: verify `isLoadingInitial` states, `photos` state updates on success, error state on failure.
    * `ImageRepositoryImpl`: Test `getCuratedPhotos` method logic (mock `PexelsApiService`).
* **Integration Tests (UI Tests using Jetpack Compose UI Test):**
    * (To be formalized later) Test `HomeScreen` displays `LazyVerticalStaggeredGrid` with items when ViewModel provides data. Test loading indicator visibility.
    * _(Refer to `testing-strategy.md` for HomeScreen UI test considerations.)_
* **Manual/CLI Verification:**
    * AC1: Run app. Verify `HomeScreen` is the first screen.
    * AC2: Verify (via logs/debugger) `HomeScreenViewModel` is created and calls `imageRepository.getCuratedPhotos`.
    * AC3, AC4: Confirm ViewModel exposes `photos` and `isLoadingInitial` states.
    * AC7: While loading, verify a loading indicator is shown.
    * AC5, AC6: After loading, verify photos are displayed in a `LazyVerticalStaggeredGrid`. Check images of different aspect ratios are rendered correctly by Coil within `ImageItem`.
* _(Hint: See `testing-strategy.md` and `research-homescreen-trending-photos.md`.)_

